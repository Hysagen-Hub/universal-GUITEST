local UserInputService = game:GetService('UserInputService')
local CollectionService = game:GetService('CollectionService')
local Players = game:GetService('Players')
local RunService = game:GetService('RunService')
local player = Players.LocalPlayer
local playerGui = player:WaitForChild('PlayerGui')

local mapFolder = workspace
    :WaitForChild('Map')
    :WaitForChild('Ingame')
    :WaitForChild('CurrencyLocations')

local highlightingEnabled = false
local highlights = {}
local highlightedOnce = false

local function notify(text)
    local screenGui = playerGui:FindFirstChild('HighlightNotify')
    if not screenGui then
        screenGui = Instance.new('ScreenGui')
        screenGui.Name = 'HighlightNotify'
        screenGui.ResetOnSpawn = false
        screenGui.Parent = playerGui

        local label = Instance.new('TextLabel')
        label.Name = 'NotifyLabel'
        label.BackgroundColor3 = Color3.new(0, 0, 0)
        label.BackgroundTransparency = 0.5
        label.TextColor3 = Color3.new(1, 1, 1)
        label.Size = UDim2.new(0, 250, 0, 40)
        label.Position = UDim2.new(1, -260, 0.8, 0)
        label.Font = Enum.Font.SourceSansBold
        label.TextSize = 18
        label.Parent = screenGui
    end

    local label = screenGui.NotifyLabel
    label.Text = text
    label.Visible = true

    delay(2.5, function()
        if label then
            label.Visible = false
        end
    end)
end

local function clearHighlights()
    for _, highlight in pairs(highlights) do
        if highlight and highlight.Parent then
            highlight:Destroy()
        end
    end
    highlights = {}
end

local function findTargets()
    local targets = {}

    for _, model in pairs(mapFolder:GetChildren()) do
        local modelName = model.Name:lower()
        if
            model:IsA('Model')
            and (
                modelName == 'toon dusek'
                or modelName == 'doothsek'
                or modelName == 'dumsek'
                or modelName == 'dusek'
                or modelName == 'umdum'
            )
        then
            for _, obj in pairs(model:GetChildren()) do
                if obj:IsA('BasePart') then
                    table.insert(targets, obj)
                end
            end
        end
    end

    return targets
end

local function highlightTarget(part)
    -- Проверяем, чтобы не дублировать подсветку
    for _, hl in pairs(highlights) do
        if hl.Adornee == part then
            return
        end
    end
    local highlight = Instance.new('Highlight')
    highlight.Adornee = part
    highlight.FillColor = Color3.fromRGB(255, 170, 0)
    highlight.FillTransparency = 0.4
    highlight.OutlineColor = Color3.fromRGB(255, 140, 0)
    highlight.OutlineTransparency = 0
    highlight.Parent = part
    table.insert(highlights, highlight)
end

local function highlightTargets(parts)
    clearHighlights()
    for _, part in pairs(parts) do
        highlightTarget(part)
    end
    notify('Подсветка Toon Dusek включена')
end

mapFolder.DescendantAdded:Connect(function(descendant)
    if highlightingEnabled and descendant:IsA('BasePart') then
        -- Проверяем, что это часть модели с нужным именем
        local model = descendant:FindFirstAncestorOfClass('Model')
        if model then
            local modelName = model.Name:lower()
            if
                modelName == 'toon dusek'
                or modelName == 'doothsek'
                or modelName == 'dumsek'
                or modelName == 'dusek'
                or modelName == 'umdum'
            then
                highlightTarget(descendant)
            end
        end
    end
end)

RunService.Heartbeat:Connect(function()
    if highlightingEnabled then
        local parts = findTargets()
        if #parts > 0 then
            if not highlightedOnce then
                highlightTargets(parts)
                highlightedOnce = true
            end
        else
            clearHighlights()
            highlightedOnce = false
        end
    end
end)

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then
        return
    end
    if input.KeyCode == Enum.KeyCode.P then
        highlightingEnabled = not highlightingEnabled

        if highlightingEnabled then
            local parts = findTargets()
            if #parts > 0 then
                highlightTargets(parts)
                highlightedOnce = true
            else
                notify(
                    'Объекты для подсветки не найдены'
                )
            end
        else
            clearHighlights()
            highlightedOnce = false
            notify('Подсветка Toon Dusek выключена')
        end
    end
end)
